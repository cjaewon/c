<!doctype html><html lang=ko><head><title>Yarn과 함께 모노레포 흟어보기 | ㅊ.JAEWON</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,minimum-scale=1"><link rel=canonical href=https://c.cjaewon.com/articles/monorepo-with-yarn/><meta name=keywords content="Cjaewon,Nodejs,Golang,고 언어,노드JS,JavaScript,TypeScript,기술 블로그,개발자"><meta property="og:title" content="Yarn과 함께 모노레포 흟어보기"><meta property="og:type" content="article"><meta property="og:url" content="https://c.cjaewon.com/articles/monorepo-with-yarn/"><meta name=description content="자바스크립트 생태계의 발전으로 프론트, 백엔드 및 다양한 환경들을 지원 할 수 있게 되었다. 이런 상황에서부터 여러 프로젝트에서 중복되는 코드들을 여러번 작성해야하는 문제가 발생했다. 이 문제를 해결하기 위해서 등장한 것이 바로 모노레포 개념이다."><meta property="og:description" content="자바스크립트 생태계의 발전으로 프론트, 백엔드 및 다양한 환경들을 지원 할 수 있게 되었다. 이런 상황에서부터 여러 프로젝트에서 중복되는 코드들을 여러번 작성해야하는 문제가 발생했다. 이 문제를 해결하기 위해서 등장한 것이 바로 모노레포 개념이다."><meta property="og:image" content="https://c.cjaewon.com/content/articles/thumbnail/monorepo-with-yarn.jpg"><link rel="shortcut icon" href=/app/icons/favicon-72x72.png><meta name=theme-color content="#4299E1"><link href=/style.min.d7b51aa50a863dac183f6c16c5639af433a64d0beb9864105b79dec8c84b628b.css rel=stylesheet><script type=text/javascript src=/main.min.js defer></script><link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-V02SF1CXXT"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-V02SF1CXXT');</script></head><body><main><header class=header><a href=/><img src=/app/logo.svg class=header__logo alt="cjaewon logo"></a></header><article class=article-page><header class=article-page__header><h1>Yarn과 함께 모노레포 흟어보기</h1><p class=article-page__header--footer><a href=/><span class=article-page__header--username>Cjaewon</span></a>
<span>•</span>
<span class=article-page__header--date>March 6, 2021</span></p><div class=article-page__header--tags><a href=/tags/nodejs class=tag>Nodejs</a></div></header><main class=content><img src=/content/articles/thumbnail/monorepo-with-yarn.jpg alt="Yarn과 함께 모노레포 흟어보기 섬네일"><p>자바스크립트 생태계의 발전으로 프론트, 백엔드 및 다양한 환경들을 지원 할 수 있게 되었다. 이런 상황에서부터 여러 프로젝트에서 중복되는 코드들을 여러번 작성해야하는 문제가 발생했다.
이 문제를 해결하기 위해서 등장한 것이 바로 <strong>모노레포(monorepo)</strong> 개념이다.</p><p>그중 가장 쉽게 접할 수 있는 yarn의 workspace를 이용하면 간단하게 모노레포를 사용 할 수 있다.</p><h2 id=yarns-workspace>Yarn&rsquo;s Workspace</h2><p>먼저 다음과 같이 package.json 파일에 workspaces 라는 필드를 추가해준다. (<code>private: true</code> 은 필수로 모노레포가 외부로 패키지처럼 배포될 수 없음을 알려준다.)</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;monorepo-test&#34;</span><span class=p>,</span>
  <span class=nt>&#34;private&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span> 
  <span class=nt>&#34;workspaces&#34;</span><span class=p>:</span> <span class=p>[</span>
    <span class=s2>&#34;server&#34;</span><span class=p>,</span>
    <span class=s2>&#34;admin-server&#34;</span><span class=p>,</span>
    <span class=s2>&#34;common&#34;</span>
  <span class=p>]</span>
<span class=p>}</span>
</code></pre></div><p>이로써 Yarn에게 workspaces에 명시된 프로젝트들을 모노레포로 사용한다는 것을 알려줄 수 있다. server, admin-server, common 이라는 하위 폴더들을 생성한 후에 package.json을 각각 생성해준다. (workspaces의 이름은 하위 폴더의 package.json의 name을 명시한다, 폴더 이름이 아님)</p><p>명시된 하위 폴더들은 모듈처럼 작동하게 된다. 따라서 서로서로 참조 할 수 있다. 이러한 방법으로 모노레포는 중복된 코드들을 재활용한다.</p><h2 id=모노레포의-다른-프로젝트-코드-재활용하기>모노레포의 다른 프로젝트 코드 재활용하기</h2><p>Yarn Workspace를 사용하는 모노레포에서는 코드를 재사용하기가 매우 쉽다. 먼저 <code>yarn install</code> 을 입력하면 최상위 노드모듈에 <a href=https://jhnyang.tistory.com/269>링크 파일</a>로 각각의 workspaces들을 생성한다. 그 후 코드를 사용하고자 하는 프로젝트의 package.json에 다음과 같이 디펜더시를 추가해준다.</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=p>{</span>
  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;server&#34;</span><span class=p>,</span>
  <span class=nt>&#34;license&#34;</span><span class=p>:</span> <span class=s2>&#34;MIT&#34;</span><span class=p>,</span>
  <span class=nt>&#34;dependencies&#34;</span><span class=p>:</span> <span class=p>{</span>
    <span class=nt>&#34;common&#34;</span><span class=p>:</span> <span class=s2>&#34;*&#34;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p>그럼 다음과 같이 server 프로젝트에서 common 프로젝트의 코드를 사용 할 수 있다.</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=c1>// server/index.js
</span><span class=c1></span><span class=kr>const</span> <span class=nx>database</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;common/database&#39;</span><span class=p>);</span>

<span class=c1>// common/database.js
</span><span class=c1></span><span class=kr>const</span> <span class=nx>mysql2</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;mysql2&#39;</span><span class=p>);</span>
<span class=nx>module</span><span class=p>.</span><span class=nx>require</span> <span class=o>=</span> <span class=nx>mysql2</span><span class=p>.</span><span class=nx>createConnection</span><span class=p>(</span><span class=s1>&#39;mysql://username:passwo..&#39;</span><span class=p>);</span>
</code></pre></div><p>위에서 최상위 노드모듈에 링크 파일로써 생성한다고 말했었다. 사실 workspaces들의 모든 모듈(mysql2, express)들 또한 최상위 노드모듈에 설치된다. 따라서 각각의 프로젝트들이 중복해서 설치한 모듈들은 하나만 설치되는 장점이 있다.</p><h2 id=깊게-들어가기>깊게 들어가기</h2><h3 id=typescript와-함께-쓰기>TypeScript와 함께 쓰기</h3><p>위 예제에서는 자바스크립트로 작성하였기 때문에 바로 <code>require</code> 해서 사용 할 수 있었다.</p><p>하지만 모노레포에서의 각각 패키지는 모듈처럼 동작하기 때문에 따로 타입스크립트가 함께 컴파일하지 않는다.
따라서 NodeJS가 이해 할 수 있도록 변환하는 과정이 필요한데, 가장 쉬운 방법은 컴파일 된 자바스크립트 코드와 타입들이 포함된 dist 자체를 <code>import</code> 하여 사용 하는 것이다.</p><div class=highlight><pre class=chroma><code class=language-ts data-lang=ts><span class=c1>// server/index.ts
</span><span class=c1></span><span class=kr>import</span> <span class=nx>database</span> <span class=kr>from</span> <span class=s1>&#39;common/dist/database&#39;</span><span class=p>;</span>
<span class=nx>database</span><span class=p>.</span><span class=nx>ping</span><span class=p>();</span>

<span class=c1>// common/database.ts
</span><span class=c1>// tsc -d 를 통하여 타입과 자바스크립트를 생성 &lt;중요&gt;
</span><span class=c1></span><span class=kr>import</span> <span class=nx>mysql2</span> <span class=kr>from</span> <span class=s1>&#39;mysql2&#39;</span><span class=p>;</span>

<span class=kr>const</span> <span class=nx>connection</span> <span class=o>=</span> <span class=nx>mysql2</span><span class=p>.</span><span class=nx>createConnection</span><span class=p>(</span><span class=s1>&#39;mysql://username:passwo..&#39;</span><span class=p>);</span>
<span class=kr>export</span> <span class=k>default</span> <span class=nx>connection</span><span class=p>;</span>
</code></pre></div><h3 id=docker로-배포하기>Docker로 배포하기</h3><p>일반적으로 도커와 함께 사용한다면 server와 admin-server와 같이 프로젝트 별로 다른 컨테이너로 사용하는 경우가 많을 것 이다. 이를 위해서는 다음과 같이 Dockerfile에 사용하고자하는 workspace 만 COPY 한 후 <code>yarn install --production</code> 해준다.</p><p>(이 경우에는 common, server의 의존성만 설치되고 admin-server의 의존성은 설치되지 않는다.)</p><div class=highlight><pre class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=k>FROM</span><span class=s> node:14</span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> ./package.json .<span class=err>
</span><span class=err></span><span class=k>COPY</span> ./server/package.json ./server/package.json<span class=err>
</span><span class=err></span><span class=k>COPY</span> ./common/package.json ./common/package.json<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>RUN</span> yarn install --production<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>COPY</span> ./server/dist ./server/dist<span class=err>
</span><span class=err></span><span class=k>COPY</span> ./common/dist ./common/dist<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>WORKDIR</span><span class=s> /app/server</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> NODE_ENV production<span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>EXPOSE</span><span class=s> 8000</span><span class=err>
</span><span class=err></span><span class=k>CMD</span> <span class=p>[</span> <span class=s2>&#34;node&#34;</span><span class=p>,</span> <span class=s2>&#34;dist/server.js&#34;</span> <span class=p>]</span><span class=err>
</span></code></pre></div><h2 id=마치면서>마치면서</h2><p>이 글을 통해 모노레포에 대해서 간단하게 흟어봤다. 요약하자면 모노레포를 사용하면 코드 재사용부터 중복 모듈 한번만 설치 등 편리한 기능들을 사용 할 수 있다. yarn 외에도 <a href=https://github.com/lerna/lerna>lerna</a> 라고 불리는 도구가 있는데 모노레포에 더 관심이 있으시면 참고하시면 좋을 것 같다.</p><script src=https://utteranc.es/client.js repo=cjaewon/c issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></main></article></main></body></html>